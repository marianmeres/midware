# @marianmeres/midware - LLM Context Document

## Package Identity
- Name: @marianmeres/midware
- Version: 1.2.0
- Type: TypeScript middleware framework
- Runtime: Deno, Node.js
- Registry: JSR (jsr:@marianmeres/midware)
- License: MIT

## Purpose
A minimalistic, type-safe middleware framework for executing functions in series with support for timeouts, priority sorting, and duplicate detection.

## File Structure
```
src/
├── mod.ts                    # Main export file (re-exports all public API)
├── midware.ts                # Core Midware class and types
└── utils/
    ├── with-timeout.ts       # withTimeout function and TimeoutError class
    └── sleep.ts              # sleep utility function
tests/
└── midware.test.ts           # Test suite (11 tests)
```

## Public API

### Types

#### MidwareUseFn<T extends unknown[]>
Middleware function type. T is a tuple of arguments passed to the middleware.
- Returns: any (undefined continues chain, other values terminate)
- Optional properties:
  - __midwarePreExecuteSortOrder?: number (lower = higher priority)
  - __midwareDuplicable?: boolean (allow duplicate registration)

#### MidwareOptions
Constructor options interface:
- preExecuteSortEnabled?: boolean (default: false)
- duplicatesCheckEnabled?: boolean (default: false)

### Classes

#### Midware<T extends unknown[]>
Main middleware manager class.

Constructor:
- new Midware(midwares?: MidwareUseFn<T>[], options?: MidwareOptions)

Properties:
- options: MidwareOptions (mutable)

Methods:
- use(midware: MidwareUseFn<T>, timeout?: number): void
  Adds middleware to end of stack. Timeout wraps with TimeoutError protection.

- unshift(midware: MidwareUseFn<T>, timeout?: number): void
  Adds middleware to beginning of stack.

- remove(midware: MidwareUseFn<T>): boolean
  Removes specific middleware. Returns true if found. Note: timeout-wrapped
  middlewares cannot be removed by original reference.

- clear(): void
  Removes all middlewares.

- execute(args: T, timeout?: number): Promise<unknown>
  Executes all middlewares in series. Returns terminating middleware's return
  value or undefined. Total timeout applies to entire chain.

#### TimeoutError extends Error
Custom error thrown when timeout is exceeded.

### Functions

#### withTimeout<T>(fn: CallableFunction, timeout?: number, errMessage?: string): (...args: any[]) => Promise<T>
Wraps function with timeout protection. Default timeout: 1000ms.
Throws TimeoutError on timeout.

#### sleep(timeout: number, __timeout_ref__?: { id: number }): Promise<void>
Promise-based delay. Optional ref for timer cancellation.

## Execution Behavior

1. Middlewares execute sequentially (in series, not parallel)
2. Each middleware receives same args tuple
3. Returning undefined continues to next middleware
4. Returning any other value terminates chain and returns that value
5. If preExecuteSortEnabled: middlewares sorted by __midwarePreExecuteSortOrder
6. Sorted order is cached until stack changes (use/unshift/remove/clear)

## Error Handling

- TypeError: Thrown when non-function passed to use/unshift
- Error: Thrown on duplicate middleware (when duplicatesCheckEnabled=true)
- TimeoutError: Thrown when middleware or total execution exceeds timeout

## Common Patterns

### Request/Response Pipeline
```typescript
const app = new Midware<[Request, Response]>();
app.use((req, res) => { /* logging */ });
app.use((req, res) => { /* auth check, may return early */ });
app.use((req, res) => { /* business logic */ });
await app.execute([request, response]);
```

### Context Object Pattern
```typescript
const app = new Midware<[Context]>();
app.use((ctx) => { ctx.startTime = Date.now(); });
app.use((ctx) => { /* process */ });
await app.execute([{ data: "input" }]);
```

### Guard/Early Return Pattern
```typescript
app.use((ctx) => {
  if (!ctx.authorized) return { error: "Forbidden" };
  // returning non-undefined stops chain
});
```

## Testing
Run tests: `deno test`
Watch mode: `deno task test`

## Build
NPM build: `deno task npm:build`
NPM publish: `deno task npm:publish`

## Important Implementation Notes

1. Timeout-wrapped middlewares create new function references, breaking:
   - Duplicate detection (won't detect as duplicate)
   - remove() method (can't remove by original reference)

2. Sort caching: Sorted middleware array is cached and only recalculated when
   #isDirty flag is set (by use/unshift/remove/clear operations).

3. Args normalization: execute() wraps non-array args in array automatically.

4. The options object is public and can be modified after construction.
